<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/search.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      media="print"
      onload="this.media='all'"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LocalBang</title>
    <meta
      name="description"
      content="A better better default search engine (with bangs!)"
    />
    <style>
      /* @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"); */

      /* Font fallback that closely matches Inter metrics */
      @font-face {
        font-family: "Inter Fallback";
        size-adjust: 107%;
        ascent-override: 90%;
        src: local("Arial");
      }

      :root {
        font-family:
          Inter,
          "Inter Fallback",
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Oxygen,
          Ubuntu,
          Cantarell,
          "Open Sans",
          "Helvetica Neue",
          sans-serif;
        font-synthesis: none;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        width: 100%;
      }

      body {
        line-height: 1.5;
        font-weight: 400;
        font-size: 16px;
        color: #1a1a1a;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 600;
        line-height: 1.2;
      }

      a {
        color: #444444;
      }

      a:hover {
        color: #888888;
      }

      button {
        font: inherit;
        border: none;
        background: none;
        cursor: pointer;
      }

      input,
      textarea {
        font: inherit;
      }

      /* Add these new styles */
      .url-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
      }

      /* Add this new style */
      .content-container {
        max-width: 36rem;
        text-align: center;
      }

      /* Update url-input width to be 100% since container will control max width */
      .url-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        background: #f5f5f5;
      }

      .copy-button {
        padding: 8px;
        color: #666;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .copy-button:hover {
        background: #f0f0f0;
      }

      .copy-button:active {
        background: #e5e5e5;
      }

      .copy-button img {
        width: 20px;
        height: 20px;
      }

      .copy-button.copied {
        background: #28a745;
      }

      .default-bang-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        background: #f5f5f5;
      }
    </style>
  </head>
  <body style="background-color: transparent">
    <div id="app"></div>
    <script>
      let bangs;

      fetch("https://raw.githubusercontent.com/elouangrimm/localbang/refs/heads/main/bang.js")
        .then((response) => response.text())
        .then((data) => {
          eval(data);
        })
        .catch((error) => {
          console.error("Error fetching bang.js:", error);
        });

      function noSearchDefaultPageRender() {
        const app = document.querySelector("#app");
        if (app) {
          const currentUrl = window.location.href;

          app.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
        <div class="content-container">
          <h1>LocalBang</h1>
          <p>DuckDuckGo's bang redirects are too slow. Add the following URL as a custom search engine to your browser. Enables <a href="https://unduck-bangs.netlify.app/" target="_blank">all of DuckDuckGo's bangs.</a></p>
          <div class="url-container"> 
            <input 
              type="text" 
              class="url-input"
              value="${currentUrl}/?q=%s"
              readonly 
            />
            <button class="copy-button">
              <img src="/public/clipboard.svg" alt="Copy" />
            </button>
            <br>
            <p id="customize-link-container">
              <a href="#" id="customize-link">Want to customize the default bang?</a>
            </p>
            <div id="customize-section" style="display: none;">
              <input 
                type="text" 
                id="default-bang-input"
                class="url-input"
                placeholder="!g (default)" 
              />
            </div>
          </div>
        </div>
      </div>
    `;

          const copyButton = app.querySelector(".copy-button");
          const copyIcon = copyButton.querySelector("img");
          const urlInput = app.querySelector(".url-input");
          const customizeLink = document.getElementById("customize-link");
          const customizeSection = document.getElementById("customize-section");
          const defaultBangInput = document.getElementById("default-bang-input");
          const customizeLinkContainer = document.getElementById(
            "customize-link-container"
          );
          const originalUrl = urlInput?.value || "";

          if (customizeLink) {
            customizeLink.addEventListener("click", (e) => {
              e.preventDefault();
              customizeSection.style.display = "block";
              customizeLinkContainer.style.display = "none";
            });
          }

          if (defaultBangInput) {
            const currentUrl = window.location.href;
            defaultBangInput.addEventListener("input", () => {
              const defaultBang = defaultBangInput.value.trim();
              if (defaultBang === "") {
                urlInput.value = originalUrl;
              } else {
                urlInput.value = `${currentUrl}/?q=%s&default=${defaultBang}`;
              }
            });
          }

          if (copyButton) {
            copyButton.addEventListener("click", async () => {
              await navigator.clipboard.writeText(urlInput.value);
              copyIcon.src = "/public/clipboard-check.svg";

              setTimeout(() => {
                copyIcon.src = "/public/clipboard.svg";
              }, 2000);
            });
          }
        }
      }

      function getBangredirectUrl() {
        const url = new URL(window.location.href);
        const query = url.searchParams.get("q")?.trim() ?? "";
        const urlDefault =
          url.searchParams.get("default")?.trim() ??
          localStorage.getItem("default-bang") ??
          "g";
        const defaultBang = bangs.find((b) => b.t === urlDefault);
        if (!query) {
          noSearchDefaultPageRender();
          return null;
        }

        const match = query.match(/!([a-z0-9]+)/i);

        const bangCandidate = match?.[1]?.toLowerCase();
        const selectedBang =
          bangs.find((b) => b.t === bangCandidate) ?? defaultBang;

        // Remove the first bang from the query
        const cleanQuery = query.replace(/![a-z0-9]+\s*/i, "").trim();

        // Format of the url is:
        // https://www.google.com/search?q={{{s}}}
        const searchUrl = selectedBang?.u.replace(
          "{{{s}}}",
          // Replace %2F with / to fix formats like "!ghr+t3dotgg/unduck"
          encodeURIComponent(cleanQuery).replace(/%2F/g, "/")
        );
        if (!searchUrl) return null;

        return searchUrl;
      }

      function doRedirect() {
        const searchUrl = getBangredirectUrl();
        if (!searchUrl) return;
        window.location.replace(searchUrl);
      }

      doRedirect();
    </script>
  </body>
</html>